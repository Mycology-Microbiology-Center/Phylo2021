# Visualization of trees

## Setting up an R-Studio project

For convenience, we suggest working with R from [RStudio](https://www.rstudio.com/products/rstudio/download/). Before starting, make a directory for your project, create folder ``data`` inside of it, and put two trees and table for label renaming in ``data``. Then, in R-Studio go ``File -> New Project -> Existing Directory`` and select the parental directory you've just created. To make a place for your code, go ``File -> New File -> R Script`` and save it in the project directory.

## Import of trees in R environment

To handle trees we will primarily use popular packages ``treeio`` (for tree import and format conversions) and ``ggtree`` (for visualizations). For documentation on these, see https://yulab-smu.top/treedata-book/index.html. ``ggtree`` produces plots using ``ggplot2`` capabilities and synax. We also will use a few functions from ``ape`` and ``geiger`` - two other widely used phylogenetic packages.

Load packages:
````rscript
library(treeio)
library(ggtree)
library(ape)
library(ggplot2)
library(geiger)
````

## Tree import

Read trees: maximum likelihood tree with bootstraps and Bayesian tree with posterior probabilities:
````rscript
bootTree <- read.newick ('data/tree_raxml.nwk')
bayesTree <- read.nexus ('data/tree_mrbayes.nex')
````

Baesian tree file includes 2 trees: first with posteriors, and second without them (topology only). We will operate on the first.
````rscript
bayesTree <- bayesTree[[1]]
````

## Visual check of the trees

Here you can see a typical ``ggplot2``-styled syntax defining parts of the graph. ``ggtree`` itself draws a naked tree, ``geom_tiplab`` adds labels to tips, ``geom_text2`` adds text to the plot  - in this case support values stored in ``label`` field, and ``xlim`` is needed to shrink tree horizontally, to avoid truncation of long labels.

````rscript
ggtree(bootTree) +
  geom_tiplab() +
  geom_text2(
    aes(label = label, subset = !isTip),
    hjust = 1.3,
    vjust = -0.4,
    size = 2
  ) +
  xlim(0, 0.3)

ggtree(bayesTree) +
  geom_tiplab() +
  geom_text2(
    aes(label = round(as.numeric(label), 2), subset = !isTip),
    hjust = 1.3,
    vjust = -0.4,
    size = 2
  ) +
  xlim(0, 0.3)
  ````
  
## Detour: how to deal with comments in trees

TL;DR: Default MrBayes output needs special transformations in ``R`` for downstream plotting.

Newick and NEXUS are the most common tree formats, and in both of them, any internal-node-associated data (like bootstraps) can be stored as node _names_. In this case, it's safe to read a tree in a simple ``phylo`` format. Though, many Bayesian programs produce a complex output that cannot fit in the node names, so instead it's written in node _comments_. Here, using ``phylo`` may result in a loss of comments, so it's better to employ into more sophisticated formats: e.g. ``treedata`` used by ``treeio``/``ggtree``. To make sure comments are not lost, do not use generic ``read.nexus``, but try to find a function designed specifically for your program (see https://yulab-smu.top/treedata-book/chapter1.html).

MrBayes by default saves trees in a format friendly for FigTree (``conformat=Figtree`` in MrBayes block). We are not interested in this compatibility, so we used ``conformat=simple``. Even though, your older trees may have been formatted for FigTree, where posteriors are stored in comments (note square brackets in NEXUS). To read these properly, execute

````rscript
bayesTree2 <- read.mrbayes ('data/tree_mrbayes_figtree.nex')
````

This will produce a ``treedata`` object, that consists mainly of 2 parts: familiar ``phylo`` part with tree topology, and ``data`` with MrBayes-specific data including posteriors. Importantly, our plotting routine requires posteriors _inside_ of ``phylo``, and we acheve this with the following. (Below is MrBayes version, but it's easy to adjust for BEAST.)

````rscript
## Sort nodes in data to match node order in phylo.
bayesTree@data <-
  bayesTree@data[order(as.numeric(bayesTree@data$node)), ]
  
## Write posteriors as node labels. If tree is already rooted, do not append '' to vector. 
bayesTree@phylo$node.label <-
  append ('', as.vector(subset(
    bayesTree@data$prob,
    as.numeric(bayesTree@data$node) > length(bayesTree@phylo$tip.label)
  )))
  
## Translate treedata into phylo.
bayesTree <- as.phylo(bayesTree)
````

## Rerooting

A common practice is to reroot a tree on outgroup. For the next step we need to root both trees. To do so, you need to know either:
1. Labels of outgroup taxa, or 
2. An ID of a node joining all the taxa belonging to the outgroup.

### 1. Rerooting by specifying outgroup labels

````rscript
## Bayesian tree:
bayesTree_rooted <-
  ape::root(bayesTree,
            outgroup = c('MM35985', 'MYX328'),
            edgelabel = TRUE)
            
## Same for ML tree:
bootTree_rooted <-
  ape::root(bootTree,
            outgroup = c('MM35985', 'MYX328'),
            edgelabel = TRUE)            
````

Note: ``edgelabel = T`` is essential for correct label placement, otherwise labels can slip to wrong branches. For details see Czech et al. 2017 "A Critical Review on the Use of Support Values in Tree Viewers and Bioinformatics Toolkits" https://doi.org/10.1093/molbev/msx055

### 2. Rerooting by specifying node ID

If outgroup is large, the option with node ID may be preferable. The easiest way to locate needed ID is to plot all of them (here on example of Bayesian tree).

````rscript
ggtree(bayesTree) +
  geom_tiplab() +
  geom_text(
    aes(label = node),
    hjust = 1.3,
    vjust = 1.3,
    size = 2,
    color = 'red'
  ) +
  xlim(0, 0.3)
````
